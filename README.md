# LLM DB Analysis Service 🤖

Асинхронный REST API сервис для анализа структуры таблиц в Lakehouse с использованием LLM (Large Language Models). Сервис позволяет отправлять схемы баз данных на анализ и получать рекомендации по рефакторингу и улучшению.

## 🏗️ Архитектура

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│  FastAPI    │─────▶│   Kafka     │─────▶│   Worker    │
│  REST API   │      │   Queue     │      │   (LLM)     │
└─────────────┘      └─────────────┘      └─────────────┘
       │                                          │
       ▼                                          ▼
┌─────────────────────────────────────────────────────┐
│              PostgreSQL Database                     │
└─────────────────────────────────────────────────────┘
```

**Стек технологий:**
- **FastAPI** - REST API сервер
- **Kafka** - очередь задач для асинхронной обработки
- **PostgreSQL** - хранение задач и результатов
- **LLM API** - интеграция с языковой моделью для анализа
- **Docker Compose** - оркестрация сервисов

## 🎯 Принцип работы

1. **POST /new** - клиент отправляет схему БД на анализ
2. Сервис создает задачу в PostgreSQL со статусом `pending`
3. Задача отправляется в Kafka топик
4. Worker получает задачу из Kafka и отправляет запрос в LLM
5. Результат анализа сохраняется в PostgreSQL
6. **GET /status** - клиент проверяет статус задачи
7. **GET /getresult** - клиент получает результат анализа

**Возможные статусы задачи:**
- `pending` - задача в очереди
- `processing` - задача обрабатывается
- `completed` - задача выполнена успешно
- `failed` - ошибка при выполнении

## 🚀 Быстрый старт

### Предварительные требования

- Docker и Docker Compose
- Доступ к LLM API (локальному или удаленному)

### Запуск сервиса

1. **Клонируйте репозиторий:**
```bash
git clone <repository-url>
cd <repository-name>
```

2. **Запустите все сервисы:**
```bash
docker-compose up -d
```

Все компоненты (API, Worker, PostgreSQL, Kafka) запустятся автоматически.

3. **Проверьте статус:**
```bash
docker-compose ps
```

## 🌐 Ссылки на сервисы
- **API документация (Swagger):** `http://185.170.153.129:8000/docs`

## 📡 API

Сервис предоставляет три основных эндпоинта:

### Создание задачи
```http
POST /new
```
Принимает схему БД и параметры анализа. Возвращает уникальный ID задачи.

### Проверка статуса
```http
GET /status?taskid=<task_id>
```
Возвращает текущий статус задачи и прогресс выполнения.

### Получение результата
```http
GET /getresult?taskid=<task_id>
```
Возвращает результат анализа (доступен только для завершенных задач).

Подробная документация доступна в Swagger UI по адресу `/docs`.

## 🔧 Конфигурация

Основные настройки находятся в `docker-compose.yml` и классе `Config`:

- **Kafka:** `localhost:9092`
- **PostgreSQL:** `localhost:5432`
- **API Server:** `localhost:8000`
- **Kafka Topic:** `db_analysis_tasks`

## 📊 Мониторинг

### Логи сервисов

```bash
# Все логи
docker-compose logs -f

# Логи API
docker-compose logs -f api

# Логи Worker
docker-compose logs -f worker

# Логи Kafka
docker-compose logs -f kafka
```

### Kafka UI

Мониторинг Kafka топиков, сообщений и consumer groups доступен через веб-интерфейс:
`http://185.170.153.129:8080/`

## 🛠️ Разработка

### Структура проекта

```
.
├── main.py              # FastAPI приложение
├── worker.py            # Kafka consumer воркер
├── docker-compose.yml   # Docker конфигурация
├── Dockerfile           # Docker образ приложения
├── requirements.txt     # Python зависимости
└── README.md            # Документация
```

### Остановка сервисов

```bash
# Остановить все контейнеры
docker-compose down

# Остановить и удалить volumes (полная очистка)
docker-compose down -v
```

## 📝 Лицензия

MIT

## 👥 Авторы

Команда Kapitoshki MISIS
---
